version: "3.9"

services:
  db:
    image: postgres:16-alpine
    container_name: livex_db
    env_file:
      - ${ENV_FILE:-.env.development} # <- aquí están tus POSTGRES_*
    environment:
      PGTZ: America/Bogota # (opcional) algo que NO pise POSTGRES_*
    ports:
      - "5432:5432"
    volumes:
      - dbdata:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      # Usa las variables del contenedor. Ojo con los $$ para que Compose no las expanda.
      test:
        [
          "CMD-SHELL",
          "PGUSER=$${POSTGRES_USER:-postgres} PGDATABASE=$${POSTGRES_DB:-postgres} pg_isready -q",
        ]
      interval: 5s
      timeout: 30s
      retries: 10
    networks:
      - livex_net

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: livex_rabbit
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-livex}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-livex}
      RABBITMQ_ERLANG_COOKIE: ${RABBITMQ_ERLANG_COOKIE:-secret_cookie_123}
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # UI
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - livex_net

  # SMTP para pruebas (solo dev/staging)
  mailpit:
    image: axllent/mailpit:latest
    container_name: livex_mailpit
    profiles: ["dev", "staging"]
    command: ["--webroot", "/mailpit"]
    ports:
      - "1025:1025" # SMTP
      - "8025:8025" # UI
    healthcheck:
      test: ["CMD", "wget", "-qO", "-", "http://127.0.0.1:8025/mailpit/"]
      interval: 10s
      timeout: 10s
      retries: 10
    networks:
      - livex_net

  # API (backend)
  app:
    build:
      context: .
      target: ${BUILD_TARGET:-dev}
    container_name: livex_api
    restart: always
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    env_file:
      - ${ENV_FILE:-.env.development}
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-3000}
    ports:
      - "${PORT:-3000}:3000"
    command: ["sh", "-c", "echo 'Esperando a la DB...' && sleep 10 && ${APP_COMMAND:-npm run dev}"]
    volumes:
      - type: bind
        source: .
        target: /app
      - /app/node_modules
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
    networks:
      - livex_net

  # Worker (consumidor de colas/webhooks)
  worker:
    build:
      context: .
      target: ${BUILD_TARGET:-dev}
    container_name: livex_worker
    restart: always
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    env_file:
      - ${ENV_FILE:-.env.development}
    environment:
      NODE_ENV: ${NODE_ENV:-development}
    command: ["sh", "-c", "echo '⏳ Esperando a que la DB se estabilice...' && sleep 15 && ${WORKER_COMMAND:-npm run dev}"]
    volumes:
      - type: bind
        source: .
        target: /app
      - /app/node_modules
    healthcheck:
      test: ["CMD-SHELL", 'node -e "process.exit(0)"'] # placeholder
    networks:
      - livex_net

  notification-worker:
    build:
      context: .
      target: ${BUILD_TARGET:-dev}
    container_name: livex_notification-worker
    restart: always
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      mailpit:
        condition: service_healthy
    env_file:
      - ${ENV_FILE:-.env.development}
    environment:
      NODE_ENV: ${NODE_ENV:-development}
    command: ["sh", "-c", "echo '⏳ Esperando a que la DB se estabilice...' && sleep 15 && ${WORKER_COMMAND:-npm run notification-worker:dev}"]
    volumes:
      - type: bind
        source: .
        target: /app
      - /app/node_modules
    healthcheck:
      test: ["CMD-SHELL", 'node -e "process.exit(0)"'] # placeholder
    networks:
      - livex_net

  booking-expiry-worker:
    build:
      context: .
      target: ${BUILD_TARGET:-dev}
    container_name: livex_booking-expiry-worker
    restart: always
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ${ENV_FILE:-.env.development}
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      BOOKING_PENDING_TTL_MINUTES: ${BOOKING_PENDING_TTL_MINUTES:-15}
    command:
      [
        "sh",
        "-c",
        "${BOOKING_EXPIRY_WORKER_COMMAND:-npm run booking-expiry-worker:dev}",
      ]
    volumes:
      - type: bind
        source: .
        target: /app
      - /app/node_modules
    healthcheck:
      test: ["CMD-SHELL", 'node -e "process.exit(0)"'] # placeholder
    networks:
      - livex_net

  payment-reconciliation-worker:
    build:
      context: .
      target: ${BUILD_TARGET:-dev}
    container_name: livex_payment-reconciliation-worker
    restart: always
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ${ENV_FILE:-.env.development}
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      RECONCILIATION_INTERVAL_MS: ${RECONCILIATION_INTERVAL_MS:-86400000}
    command:
      [
        "sh",
        "-c",
        "${PAYMENT_RECONCILIATION_WORKER_COMMAND:-npm run payment-reconciliation-worker:dev}",
      ]
    volumes:
      - type: bind
        source: .
        target: /app
      - /app/node_modules
    healthcheck:
      test: ["CMD-SHELL", 'node -e "process.exit(0)"'] # placeholder
    networks:
      - livex_net

  # PDF Generation Service (Go + Maroto)
  pdf-service:
    build:
      context: ../livex-pdf-service
      dockerfile: Dockerfile
    container_name: livex_pdf_service
    restart: always
    ports:
      - "8090:8090"
    environment:
      PORT: 8090
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8090/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - livex_net

  nginx:
    image: nginx:1.27-alpine
    container_name: livex_nginx
    depends_on:
      - app
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/static:/usr/share/nginx/html/static:ro
      - ./fotos_experiencias:/usr/share/nginx/html/images:ro
      # Descomenta si usas Basic Auth:
      # - ./nginx/htpasswd:/etc/nginx/htpasswd:ro
    # restart: unless-stopped
    networks:
      - livex_net

volumes:
  dbdata:

networks:
  livex_net:
    name: livex_network
    driver: bridge
    
